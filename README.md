# Heart Attack Risk Predictor

Проект представляет собой приложение для предсказания риска сердечного приступа на основе медицинских и поведенческих данных пациентов.
Решение включает исследование данных, обучение модели машинного обучения и сервис на **FastAPI** для выполнения предсказаний на тестовой выборке.

Подробный анализ данных (EDA), выбор модели, настройка гиперпараметров и обоснование методологии представлены в Jupyter Notebook `EDA_and_modeling.ipynb`.

---

## 1. Структура проекта

```
medical_project_repo/
│
├── data/
│   ├── heart_train.csv
│   └── heart_test.csv
│
├── models/
│   ├── model.cbm
│   └── meta.json
│
├── notebooks/
│   └── EDA_and_modeling.ipynb
│
├── scripts/
│   ├── train.py
│   ├── predict.py
│
├── src/
│   ├── preprocessing/
│   │   └── preprocessor.py
│   ├── model/
│   │   └── predictor.py
│   └── api/
│       └── main.py
│
├── predictions.csv
├── fallback_ids.json
└── README.md
```

---

## 2. Используемый стек

* Python
* Pandas, NumPy
* Scikit-learn
* CatBoost
* FastAPI

---

## 3. Окружение и зависимости

Проект тестировался в окружении:

* Python 3.10 (Conda)

### Основные зависимости

* catboost==1.2.8
* pandas==2.3.3
* numpy==2.2.5
* scikit-learn==1.5.x
* scipy==1.15.3
* fastapi==0.128.0
* uvicorn==0.40.0
* pydantic==2.12.5

### Дополнительные зависимости

* matplotlib==3.10.8
* seaborn==0.13.2
* phik==0.12.5

---

## 4. Исследование данных и моделирование (EDA)

Исследование данных, анализ распределений признаков, обработка пропусков, выбор модели и настройка гиперпараметров выполнены в Jupyter Notebook:

* `EDA_and_modeling.ipynb`

В ноутбуке представлены:

* анализ качества и структуры исходных данных;
* выявление и интерпретация пропусков в данных;
* выбор модели;
* подбор оптимального порога классификации;
* выводы по качеству модели.

Все архитектурные и методологические решения, использованные в приложении, основаны на результатах данного исследования.

---

## 5. Обучение модели

Для обучения модели используется очищенная тренировочная выборка без пропусков.
Строки с техническими пропусками не используются при обучении.

Запуск обучения из корня проекта:

```bash
python -m scripts.train
```

В результате будут сохранены:

* модель: `models/model.cbm`
* метаданные: `models/meta.json` (список признаков, порог классификации и настройки вывода)

---

## 6. Локальное получение предсказаний (без API)

Предсказания формируются **строго для всех строк тестового файла**, как требуется в техническом задании.

### Логика обработки

* для строк **без пропусков** используется обученная модель;
* для строк **с пропусками** применяется fallback-логика: `prediction = 0`;
* итоговый файл формируется **в исходном порядке строк CSV-файла**;
* дополнительно сохраняется отдельный список `id`, для которых была применена fallback-логика.

Запуск:

```bash
python -m scripts.predict
```

Результаты:

* `predictions.csv` — файл с колонками `id, prediction` (строго по ТЗ);
* `fallback_ids.json` — список `id`, для которых была применена fallback-логика (`prediction = 0`) из-за наличия пропусков в данных.

---

## 7. Запуск FastAPI сервиса

Запуск сервиса из корня проекта:

```bash
uvicorn src.api.main:app --reload
```

Swagger-документация доступна по адресу:

```
http://127.0.0.1:8000/docs
```

---

## 8. Использование API

### Endpoint

`POST /predict`

### Входные данные

JSON с путём к CSV-файлу на диске:

```json
{
  "csv_path": "data/heart_test.csv"
}
```

### Логика обработки

* предсказания выполняются **только для строк без NaN**;
* строки с пропусками получают `prediction = 0` (fallback-логика);
* итог возвращается **в исходном порядке исходного CSV-файла**;
* дополнительно возвращается отдельный список `id`, для которых была применена fallback-логика из-за наличия пропусков в данных.

### Ответ

```json
{
  "predictions": [
    {"id": 123, "prediction": 0},
    {"id": 124, "prediction": 1}
  ],
  "fallback_ids": [456, 789]
}
```

---

## 9. Проверки соответствия техническому заданию

Гарантируется:

* `predictions.csv` содержит **ровно 2 колонки**: `id`, `prediction`;
* количество строк совпадает с исходным тестовым файлом;
* пропусков в `prediction` нет;
* значения `prediction` принадлежат множеству `{0, 1}`;
* порядок строк полностью соответствует исходному CSV;
* дополнительно формируется список `id`, для которых была применена fallback-логика.

---

## 10. Примечания по методологии

* Пропуски в данных имеют **системный и технический характер**, поэтому не имитируются и не импутируются.
* Для медицинской задачи выбран консервативный подход: строки с пропусками получают `prediction = 0`.
* Формируется отдельный список `id`, для которых была применена fallback-логика.
* Основная метрика качества модели — **ROC-AUC**, дополнительная — **F1-score** с оптимизированным порогом классификации.
* Использована модель **CatBoostClassifier**, устойчивая к нелинейностям и выбросам.

---

## 11. Итог

Проект реализует полный ML-пайплайн:

* исследование и анализ данных;
* обучение и оценку модели;
* воспроизводимые предсказания;
* сервис для использования модели;
* строгую валидацию формата ответа в соответствии с техническим заданием.
